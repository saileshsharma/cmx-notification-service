<!-- Toast Notifications (controlled by in-app-notifications flag) -->
<div class="toast-container" *ngIf="isFeatureEnabled('in-app-notifications')">
  <div *ngFor="let toast of toasts" class="toast" [class]="toast.type" [class.animated]="isFeatureEnabled('animations-enabled')" (click)="removeToast(toast.id)">
    <div class="toast-icon">
      <span *ngIf="toast.type === 'success'">&#10003;</span>
      <span *ngIf="toast.type === 'error'">&#10007;</span>
      <span *ngIf="toast.type === 'warning'">&#9888;</span>
      <span *ngIf="toast.type === 'info'">&#8505;</span>
      <span *ngIf="toast.type === 'surveyor'" class="material-icons">person_pin</span>
    </div>
    <div class="toast-content">
      <div class="toast-title" *ngIf="toast.title">{{toast.title}}</div>
      <div class="toast-message">{{toast.message}}</div>
    </div>
  </div>
</div>

<!-- Confirmation/Alert Modal -->
<div class="modal-overlay confirm-modal-overlay" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
  <div class="modal confirm-modal" [class]="confirmModalType" (click)="$event.stopPropagation()">
    <div class="confirm-modal-header">
      <div class="confirm-modal-icon">
        <span *ngIf="confirmModalType === 'confirm'">&#63;</span>
        <span *ngIf="confirmModalType === 'alert'">&#8505;</span>
        <span *ngIf="confirmModalType === 'error'">&#10007;</span>
        <span *ngIf="confirmModalType === 'warning'">&#9888;</span>
      </div>
      <h3 class="confirm-modal-title">{{confirmModalTitle}}</h3>
    </div>
    <div class="confirm-modal-body">
      <p class="confirm-modal-message">{{confirmModalMessage}}</p>
    </div>
    <div class="confirm-modal-footer">
      <button *ngIf="confirmModalType === 'confirm'" class="btn-cancel" (click)="closeConfirmModal()">
        {{confirmModalCancelText}}
      </button>
      <button class="btn-confirm" [class]="confirmModalType" (click)="confirmModalAction()">
        {{confirmModalConfirmText}}
      </button>
    </div>
  </div>
</div>

<!-- Quick Add FAB -->
<div class="fab-container">
  <button class="fab" (click)="toggleQuickAddMenu()" [class.active]="showQuickAddMenu">
    <span>{{showQuickAddMenu ? '&#10005;' : '&#43;'}}</span>
  </button>
  <div class="fab-menu" *ngIf="showQuickAddMenu">
    <div class="fab-item" *ngFor="let template of templates" (click)="quickAddFromTemplate(template)">
      <span class="fab-icon" [style.background-color]="template.color">{{template.duration}}h</span>
      <span class="fab-label">{{template.name}}</span>
    </div>
    <div class="fab-item" (click)="openQuickAddModal()">
      <span class="fab-icon custom">&#128397;</span>
      <span class="fab-label">Custom...</span>
    </div>
  </div>
</div>

<header>
  <div class="header-left">
    <div class="logo">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <strong>Dispatcher Calendar</strong>
    </div>
  </div>

  <!-- View Toggle (Center) -->
  <div class="header-center">
    <div class="view-toggle">
      <button [class.active]="currentView === 'calendar'" (click)="setView('calendar')" title="Calendar View">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <span>Calendar</span>
      </button>
      <button [class.active]="currentView === 'timeline'" (click)="setView('timeline')" title="Timeline View">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="4" y1="6" x2="20" y2="6"></line>
          <line x1="4" y1="12" x2="16" y2="12"></line>
          <line x1="4" y1="18" x2="12" y2="18"></line>
        </svg>
        <span>Timeline</span>
      </button>
      <button [class.active]="currentView === 'heatmap'" (click)="setView('heatmap')" title="Heatmap View">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>Heatmap</span>
      </button>
      <button *ngIf="isFeatureEnabled('real-time-tracking') && isFeatureEnabled('google-maps-integration')" [class.active]="currentView === 'map'" (click)="setView('map')" title="Surveyor Location Map">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <span>Map</span>
      </button>
    </div>
  </div>

  <div class="header-right">
    <!-- Alerts -->
    <div class="alerts-container">
      <button class="btn-icon" (click)="toggleAlertsPanel()" [class.has-alerts]="upcomingAlerts.length > 0" title="Tomorrow's Schedule">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <span class="alerts-badge" *ngIf="upcomingAlerts.length > 0">{{upcomingAlerts.length}}</span>
      </button>
      <div class="alerts-panel" *ngIf="showAlertsPanel" (click)="$event.stopPropagation()">
        <div class="alerts-header">
          <strong>Tomorrow's Schedule</strong>
          <button class="close-btn" (click)="toggleAlertsPanel()">&#10005;</button>
        </div>
        <div class="alerts-list" *ngIf="upcomingAlerts.length > 0">
          <div *ngFor="let alert of upcomingAlerts" class="alert-item" [class.busy]="alert.state === 'BUSY'" [class.offline]="alert.state === 'OFFLINE'">
            <span class="alert-time">{{alert.startTime}}</span>
            <span class="alert-name">{{alert.surveyorName}}</span>
            <span class="alert-state">{{alert.state}}</span>
          </div>
        </div>
        <div class="no-alerts" *ngIf="upcomingAlerts.length === 0">
          No appointments scheduled for tomorrow
        </div>
      </div>
    </div>

    <div class="header-divider"></div>

    <!-- Scheduling Conflicts (controlled by conflict-detection flag) -->
    <button *ngIf="isFeatureEnabled('conflict-detection')" class="btn-icon" (click)="toggleConflictPanel()" [class.active]="showConflictPanel" [class.has-warnings]="conflictWarnings.length > 0" title="Scheduling Conflicts">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
      <span class="alerts-badge" *ngIf="conflictWarnings.length > 0">{{conflictWarnings.length}}</span>
    </button>
    <!-- Workload Balance (controlled by workload-balancing flag) -->
    <button *ngIf="isFeatureEnabled('workload-balancing')" class="btn-icon" (click)="toggleWorkloadPanel()" [class.active]="showWorkloadPanel" title="Workload Balance">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="20" x2="18" y2="10"></line>
        <line x1="12" y1="20" x2="12" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="14"></line>
      </svg>
    </button>
    <!-- Travel Time (controlled by eta-tracking flag) -->
    <button *ngIf="isFeatureEnabled('eta-tracking')" class="btn-icon" (click)="toggleTravelTimes()" [class.active]="showTravelTimePanel" title="Travel Time Analysis">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <span class="alerts-badge" *ngIf="hasTightSchedules()">!</span>
    </button>

    <div class="header-divider"></div>

    <!-- Dashboard Toggle (controlled by analytics-dashboard flag) -->
    <button *ngIf="isFeatureEnabled('analytics-dashboard')" class="btn-icon" (click)="toggleDashboard()" title="Dashboard (D)" [class.active]="showDashboard">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="9"></rect>
        <rect x="14" y="3" width="7" height="5"></rect>
        <rect x="14" y="12" width="7" height="9"></rect>
        <rect x="3" y="16" width="7" height="5"></rect>
      </svg>
    </button>
    <!-- Activity Log (controlled by audit-log-viewer flag) -->
    <button *ngIf="isFeatureEnabled('audit-log-viewer')" class="btn-icon" (click)="toggleActivityLog()" title="Activity Log" [class.active]="showActivityLog">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
      </svg>
    </button>
    <!-- Chat (controlled by feature flag) -->
    <button *ngIf="isFeatureEnabled('chat-v2')" class="btn-icon chat-toggle-btn" (click)="toggleChatPanel()" title="Chat" [class.active]="showChatPanel">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <span class="chat-badge" *ngIf="chatUnreadCount > 0">{{chatUnreadCount}}</span>
    </button>
    <!-- Export (controlled by feature flag) -->
    <button *ngIf="isFeatureEnabled('pdf-export') || isFeatureEnabled('excel-export')" class="btn-icon" (click)="openExportModal()" title="Export Data">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    </button>
    <!-- Refresh -->
    <button class="btn-icon" (click)="refreshEvents()" title="Refresh (R)">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" [class.spinning]="loadingEvents">
        <polyline points="23 4 23 10 17 10"></polyline>
        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
      </svg>
    </button>
  </div>
</header>

<!-- Dashboard Overlay (controlled by analytics-dashboard flag) -->
<div class="dashboard-overlay" *ngIf="showDashboard && isFeatureEnabled('analytics-dashboard')" (click)="toggleDashboard()">
  <div class="dashboard-panel" (click)="$event.stopPropagation()">
    <div class="dashboard-header">
      <h2>Dashboard</h2>
      <button class="close-btn" (click)="toggleDashboard()">&#10005;</button>
    </div>
    <div class="dashboard-widgets">
      <div class="widget" *ngFor="let widget of dashboardWidgets">
        <div class="widget-title">{{widget.title}}</div>
        <div class="widget-value">{{widget.value}}</div>
      </div>
    </div>
  </div>
</div>

<!-- Activity Log Panel (controlled by audit-log-viewer flag) -->
<div class="activity-log-panel" *ngIf="showActivityLog && isFeatureEnabled('audit-log-viewer')">
  <div class="activity-header">
    <div class="activity-title-row">
      <h3>Surveyor Activity</h3>
      <span class="live-indicator" *ngIf="sseConnected">
        <span class="live-dot"></span> LIVE
      </span>
    </div>
    <div class="activity-controls">
      <select [(ngModel)]="activityFilter" (change)="onActivityFilterChange()" class="activity-filter-select">
        <option value="ALL">All Activity</option>
        <option value="STATUS_CHANGE">Status Changes</option>
        <option value="JOB_UPDATE">Job Updates</option>
        <option value="LOGIN">Login/Logout</option>
      </select>
      <button class="refresh-btn" (click)="loadSurveyorActivity()" title="Refresh">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
      </button>
      <button class="close-btn" (click)="toggleActivityLog()">&#10005;</button>
    </div>
  </div>
  <div class="activity-list">
    <div *ngFor="let entry of getFilteredActivities()" class="activity-item" [ngClass]="getActivityClass(entry.activityType)">
      <div class="activity-icon-wrapper" [style.background]="getSurveyorActivityColor(entry.activityType, entry.newValue)">
        <span class="material-icons activity-icon">{{getSurveyorActivityIcon(entry.activityType, entry.newValue)}}</span>
      </div>
      <div class="activity-content">
        <div class="activity-action">
          <strong>{{entry.surveyorName || 'Surveyor ' + entry.surveyorId}}</strong>
          <span class="activity-value-badge" [style.background]="getSurveyorActivityColor(entry.activityType, entry.newValue)">
            {{getSurveyorActivityLabel(entry.activityType, entry.newValue)}}
          </span>
        </div>
        <div class="activity-meta">
          <span class="activity-datetime">{{formatActivityFullDateTime(entry.createdAt)}}</span>
          <span class="activity-time-relative">({{formatActivityTimestamp(entry.createdAt)}})</span>
        </div>
        <div class="activity-meta" *ngIf="entry.appointmentTitle">
          <span class="appointment-tag">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            {{entry.appointmentTitle}}
          </span>
        </div>
      </div>
    </div>
    <div *ngIf="surveyorActivities.length === 0 && !loadingActivities" class="no-activity">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
      </svg>
      <p>No surveyor activity yet</p>
      <span>Status changes and job updates will appear here</span>
    </div>
    <div *ngIf="loadingActivities" class="activity-loading">
      <svg class="spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
      </svg>
      Loading activity...
    </div>
  </div>
  <div class="activity-footer" *ngIf="surveyorActivities.length > 0">
    <button class="view-all-btn" (click)="openActivityHistory()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
      </svg>
      View All History
    </button>
  </div>
</div>

<!-- Activity History Modal -->
<div class="modal-overlay" *ngIf="showActivityHistoryModal" (click)="closeActivityHistory()">
  <div class="modal activity-history-modal" (click)="$event.stopPropagation()">
    <!-- Enhanced Header -->
    <div class="activity-modal-header">
      <div class="activity-header-content">
        <div class="activity-header-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="activity-header-text">
          <h2>Activity Timeline</h2>
          <p class="activity-subtitle" *ngIf="selectedSurveyor">
            <span class="surveyor-badge">
              <span class="surveyor-avatar" [style.background]="getAvatarColor(selectedSurveyor.display_name)">
                {{getInitials(selectedSurveyor.display_name)}}
              </span>
              {{selectedSurveyor.display_name}}
            </span>
            <span class="surveyor-code">{{selectedSurveyor.code}}</span>
          </p>
        </div>
      </div>
      <button class="activity-close-btn" (click)="closeActivityHistory()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Stats Bar -->
    <div class="activity-stats-bar">
      <div class="activity-stat">
        <span class="stat-value">{{activityHistoryItems.length}}</span>
        <span class="stat-label">Activities</span>
      </div>
      <div class="activity-stat">
        <span class="stat-value">{{getActivityStatCount('STATUS_CHANGE')}}</span>
        <span class="stat-label">Status Changes</span>
      </div>
      <div class="activity-stat">
        <span class="stat-value">{{getActivityStatCount('JOB_UPDATE')}}</span>
        <span class="stat-label">Job Updates</span>
      </div>
      <div class="activity-stat">
        <span class="stat-value">{{getActivityStatCount('LOGIN')}}</span>
        <span class="stat-label">Logins</span>
      </div>
    </div>

    <!-- Filter Toolbar -->
    <div class="activity-toolbar">
      <div class="activity-filter-tabs">
        <button class="filter-tab" [class.active]="activityFilter === 'ALL'" (click)="activityFilter = 'ALL'; loadActivityHistoryPage()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
          </svg>
          All
        </button>
        <button class="filter-tab" [class.active]="activityFilter === 'STATUS_CHANGE'" (click)="activityFilter = 'STATUS_CHANGE'; loadActivityHistoryPage()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
          </svg>
          Status
        </button>
        <button class="filter-tab" [class.active]="activityFilter === 'JOB_UPDATE'" (click)="activityFilter = 'JOB_UPDATE'; loadActivityHistoryPage()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
          </svg>
          Jobs
        </button>
        <button class="filter-tab" [class.active]="activityFilter === 'LOGIN'" (click)="activityFilter = 'LOGIN'; loadActivityHistoryPage()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          Access
        </button>
      </div>
      <div class="activity-page-indicator">
        Page <strong>{{activityHistoryPage + 1}}</strong>
      </div>
    </div>

    <!-- Timeline Content -->
    <div class="activity-timeline-container">
      <div class="activity-timeline" *ngIf="!loadingActivityHistory && activityHistoryItems.length > 0">
        <div *ngFor="let entry of activityHistoryItems; let i = index"
             class="timeline-entry"
             [class.timeline-entry-status]="entry.activityType === 'STATUS_CHANGE'"
             [class.timeline-entry-job]="entry.activityType === 'JOB_UPDATE'"
             [class.timeline-entry-login]="entry.activityType === 'LOGIN'">

          <!-- Timeline connector -->
          <div class="timeline-connector">
            <div class="timeline-dot" [style.background]="getSurveyorActivityColor(entry.activityType, entry.newValue)">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                <polyline *ngIf="entry.activityType === 'STATUS_CHANGE'" points="20 6 9 17 4 12"></polyline>
                <rect *ngIf="entry.activityType === 'JOB_UPDATE'" x="3" y="3" width="18" height="18" rx="2"></rect>
                <path *ngIf="entry.activityType === 'LOGIN'" d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"></path>
              </svg>
            </div>
            <div class="timeline-line" *ngIf="i < activityHistoryItems.length - 1"></div>
          </div>

          <!-- Timeline card -->
          <div class="timeline-card">
            <div class="timeline-card-header">
              <div class="timeline-user">
                <span class="timeline-avatar" [style.background]="getAvatarColor(entry.surveyorName || 'S')">
                  {{getInitials(entry.surveyorName || 'S')}}
                </span>
                <div class="timeline-user-info">
                  <span class="timeline-username">{{entry.surveyorName || 'Surveyor ' + entry.surveyorId}}</span>
                  <span class="timeline-code" *ngIf="entry.surveyorCode">{{entry.surveyorCode}}</span>
                </div>
              </div>
              <div class="timeline-badge" [style.background]="getSurveyorActivityColor(entry.activityType, entry.newValue)">
                {{getSurveyorActivityLabel(entry.activityType, entry.newValue)}}
              </div>
            </div>

            <div class="timeline-card-body">
              <div class="timeline-change" *ngIf="entry.previousValue">
                <span class="change-from">{{entry.previousValue}}</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
                <span class="change-to" [style.color]="getSurveyorActivityColor(entry.activityType, entry.newValue)">{{entry.newValue}}</span>
              </div>

              <div class="timeline-appointment" *ngIf="entry.appointmentTitle">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>{{entry.appointmentTitle}}</span>
              </div>

              <div class="timeline-location" *ngIf="entry.latitude && entry.longitude">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span>{{entry.latitude.toFixed(4)}}, {{entry.longitude.toFixed(4)}}</span>
              </div>
            </div>

            <div class="timeline-card-footer">
              <div class="timeline-time">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span class="time-full">{{formatActivityFullDateTime(entry.createdAt)}}</span>
                <span class="time-relative">{{formatActivityTimestamp(entry.createdAt)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loadingActivityHistory" class="activity-loading-state">
        <div class="loading-spinner">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" opacity="0.2"></circle>
            <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round">
              <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
            </path>
          </svg>
        </div>
        <span>Loading activity timeline...</span>
      </div>

      <!-- Empty State -->
      <div *ngIf="activityHistoryItems.length === 0 && !loadingActivityHistory" class="activity-empty-state">
        <div class="empty-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <h3>No Activity Found</h3>
        <p>There's no activity matching the selected filter for this surveyor.</p>
      </div>
    </div>

    <!-- Footer with Pagination -->
    <div class="activity-modal-footer">
      <div class="pagination-nav">
        <button class="pagination-btn" (click)="activityHistoryPrevPage()" [disabled]="activityHistoryPage === 0">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Previous
        </button>
        <div class="pagination-info">
          <span class="current-page">{{activityHistoryPage + 1}}</span>
        </div>
        <button class="pagination-btn" (click)="activityHistoryNextPage()" [disabled]="!hasMoreActivityHistory()">
          Next
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
      <button class="activity-done-btn" (click)="closeActivityHistory()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Done
      </button>
    </div>
  </div>
</div>

<div class="main-layout">
  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="sidebarCollapsed">
    <div class="sidebar-header">
      <button class="toggle-btn" (click)="toggleSidebar()">
        {{sidebarCollapsed ? '&#9654;' : '&#9664;'}}
      </button>
      <span *ngIf="!sidebarCollapsed">Surveyors</span>
    </div>

    <div class="sidebar-content" *ngIf="!sidebarCollapsed">
      <!-- Search -->
      <div class="search-box">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
        </svg>
        <input type="text" placeholder="Search surveyors..." [(ngModel)]="searchQuery" (input)="onSearchChange()">
        <button class="search-clear" *ngIf="searchQuery" (click)="clearSearch()" title="Clear search">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Search Results Count -->
      <div class="search-results-count" *ngIf="searchQuery">
        Found <strong>{{filteredSurveyors.length}}</strong> surveyor{{filteredSurveyors.length !== 1 ? 's' : ''}}
      </div>

      <!-- Quick Filters -->
      <div class="quick-filters">
        <button class="pill" [class.active]="selectedType === 'INTERNAL'" (click)="quickFilterInternal()">
          Internal
        </button>
        <button class="pill" [class.active]="selectedType === 'EXTERNAL'" (click)="quickFilterExternal()">
          External
        </button>
        <button class="pill clear" *ngIf="hasActiveFilters()" (click)="clearFilters()">
          Clear
        </button>
      </div>

      <!-- Surveyor List -->
      <div class="surveyor-list-sidebar">
        <!-- Loading Skeleton (controlled by skeleton-loading flag) -->
        <div *ngIf="loadingSurveyors && isFeatureEnabled('skeleton-loading')" class="skeleton-container">
          <div class="skeleton-item" *ngFor="let i of [1,2,3,4,5,6,7,8]">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-text">
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>
          </div>
        </div>
        <!-- Simple loading fallback when skeleton-loading is disabled -->
        <div *ngIf="loadingSurveyors && !isFeatureEnabled('skeleton-loading')" class="loading-simple">
          Loading surveyors...
        </div>

        <!-- Actual List with Sections -->
        <div *ngIf="!loadingSurveyors">
          <div class="sidebar-actions">
            <button class="small-btn" (click)="selectAllSurveyors()">Select All</button>
            <button class="small-btn" (click)="clearAllSurveyors()">Clear</button>
            <span class="count">{{selectedSurveyorIds.length}}/{{filteredSurveyors.length}}</span>
          </div>
          <!-- Bulk Assign (controlled by bulk-create-appointments flag) -->
          <div class="sidebar-actions dispatcher-actions" *ngIf="isFeatureEnabled('bulk-create-appointments')">
            <button class="action-btn bulk-btn" (click)="openBulkAssignModal()" [disabled]="selectedSurveyorIds.length === 0" title="Bulk Assign (B)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              Bulk Assign
            </button>
          </div>

          <!-- INTERNAL Section -->
          <div *ngIf="getInternalSurveyors().length > 0">
            <div class="section-header">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>Internal</span>
              <span class="section-count">{{getInternalSurveyors().length}}</span>
            </div>
            <div class="section-content">
            <div *ngFor="let s of getInternalSurveyors()" class="surveyor-card-wrapper">
              <div class="surveyor-card"
                   [class.selected]="isSurveyorSelected(s.id)"
                   [class.has-travel-warning]="showTravelTimes && getTravelTimeWarning(s.id)"
                   (click)="toggleSurveyorSelection(s.id)">
                <div class="avatar" [style.background-color]="getAvatarColor(s.display_name)">
                  <img *ngIf="!hasAvatarError(s.id)"
                       [src]="getAvatarUrl(s.display_name, 40)"
                       [alt]="s.display_name"
                       (error)="onAvatarError(s.id)"
                       class="avatar-img">
                  <span *ngIf="hasAvatarError(s.id)" class="avatar-initials">{{getInitials(s.display_name)}}</span>
                </div>
                <div class="surveyor-info">
                  <div class="surveyor-name-sidebar" [innerHTML]="highlightSearchTerm(s.display_name)"></div>
                  <div class="surveyor-meta">
                    <span class="status-dot" [style.background-color]="getCurrentStatusColor(s.current_status)"></span>
                    <span class="status-text">{{s.current_status}}</span>
                  </div>
                </div>
                <!-- Travel Time Warning Indicator -->
                <div class="travel-warning-badge"
                     *ngIf="showTravelTimes && getTravelTimeWarning(s.id) as warning"
                     [class.warning]="warning.level === 'warning'"
                     [class.critical]="warning.level === 'critical'"
                     [title]="warning.message">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </div>
                <button class="contact-btn" (click)="toggleContactInfo(s.id); $event.stopPropagation()" title="Contact Info">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                  </svg>
                </button>
                <div class="check-mark" *ngIf="isSurveyorSelected(s.id)">✓</div>
              </div>
              <!-- Contact Info Panel -->
              <div class="contact-panel" *ngIf="showContactInfo === s.id">
                <div class="contact-row" (click)="emailSurveyor(s.email || '')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                  <span>{{s.email || 'No email'}}</span>
                </div>
                <div class="contact-row" (click)="callSurveyor(s.phone || '')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                  </svg>
                  <span>{{s.phone || 'No phone'}}</span>
                </div>
              </div>
            </div>
            </div>
          </div>

          <!-- EXTERNAL Section -->
          <div *ngIf="getExternalSurveyors().length > 0">
            <div class="section-header">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <span>External</span>
              <span class="section-count">{{getExternalSurveyors().length}}</span>
            </div>
            <div class="section-content">
            <div *ngFor="let s of getExternalSurveyors()" class="surveyor-card-wrapper">
              <div class="surveyor-card"
                   [class.selected]="isSurveyorSelected(s.id)"
                   [class.has-travel-warning]="showTravelTimes && getTravelTimeWarning(s.id)"
                   (click)="toggleSurveyorSelection(s.id)">
                <div class="avatar" [style.background-color]="getAvatarColor(s.display_name)">
                  <img *ngIf="!hasAvatarError(s.id)"
                       [src]="getAvatarUrl(s.display_name, 40)"
                       [alt]="s.display_name"
                       (error)="onAvatarError(s.id)"
                       class="avatar-img">
                  <span *ngIf="hasAvatarError(s.id)" class="avatar-initials">{{getInitials(s.display_name)}}</span>
                </div>
                <div class="surveyor-info">
                  <div class="surveyor-name-sidebar" [innerHTML]="highlightSearchTerm(s.display_name)"></div>
                  <div class="surveyor-meta">
                    <span class="status-dot" [style.background-color]="getCurrentStatusColor(s.current_status)"></span>
                    <span class="status-text">{{s.current_status}}</span>
                  </div>
                </div>
                <!-- Travel Time Warning Indicator -->
                <div class="travel-warning-badge"
                     *ngIf="showTravelTimes && getTravelTimeWarning(s.id) as warning"
                     [class.warning]="warning.level === 'warning'"
                     [class.critical]="warning.level === 'critical'"
                     [title]="warning.message">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </div>
                <button class="contact-btn" (click)="toggleContactInfo(s.id); $event.stopPropagation()" title="Contact Info">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                  </svg>
                </button>
                <div class="check-mark" *ngIf="isSurveyorSelected(s.id)">✓</div>
              </div>
              <!-- Contact Info Panel -->
              <div class="contact-panel" *ngIf="showContactInfo === s.id">
                <div class="contact-row" (click)="emailSurveyor(s.email || '')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                  <span>{{s.email || 'No email'}}</span>
                </div>
                <div class="contact-row" (click)="callSurveyor(s.phone || '')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                  </svg>
                  <span>{{s.phone || 'No phone'}}</span>
                </div>
              </div>
            </div>
            </div>
          </div>

          <div *ngIf="filteredSurveyors.length === 0" class="no-results">
            No surveyors found
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content Area -->
  <div class="calendar-container">
    <!-- Calendar View -->
    <div *ngIf="currentView === 'calendar'">
      <div class="calendar-loading" *ngIf="loadingEvents">
        <div class="spinner"></div>
        <span>Loading events...</span>
      </div>
      <full-calendar [options]="calendarOptions"></full-calendar>
    </div>

    <!-- Resource Timeline View -->
    <div *ngIf="currentView === 'timeline'" class="timeline-container">
      <div class="timeline-header">
        <div class="timeline-nav">
          <button class="timeline-nav-btn" (click)="prevTimelineDay()" title="Previous Day">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <div class="timeline-date-display">
            <span class="timeline-date-label">{{getTimelineDateLabel()}}</span>
            <span class="timeline-date-full">{{timelineDate | date:'EEEE, MMMM d, y'}}</span>
          </div>
          <button class="timeline-nav-btn" (click)="nextTimelineDay()" title="Next Day">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <button class="timeline-today-btn" (click)="goToTimelineToday()" *ngIf="!isTimelineToday()">
            Today
          </button>
        </div>
        <div class="timeline-stats">
          <div class="timeline-stat">
            <span class="stat-value">{{getTimelineEventCount()}}</span>
            <span class="stat-label">Appointments</span>
          </div>
          <div class="timeline-stat">
            <span class="stat-value">{{allSurveyors.length}}</span>
            <span class="stat-label">Surveyors</span>
          </div>
        </div>
        <div class="timeline-legend">
          <div class="legend-item">
            <span class="legend-color" style="background: #dc3545"></span>
            <span>Busy</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #ffc107"></span>
            <span>Pending</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #6c757d"></span>
            <span>Offline</span>
          </div>
        </div>
      </div>
      <div class="timeline-grid">
        <div class="timeline-hours-row">
          <div class="timeline-surveyor-header">Surveyor</div>
          <div class="timeline-hours">
            <div class="hour-label" *ngFor="let hour of timelineHours">{{hour}}</div>
          </div>
        </div>
        <div class="timeline-rows">
          <!-- Global current time indicator (only for today) -->
          <div class="current-time-indicator-global"
               *ngIf="isTimelineToday() && currentTimePosition >= 0 && currentTimePosition <= 100"
               [style.left]="getCurrentTimeIndicatorStyle()">
          </div>
          <div *ngFor="let s of allSurveyors" class="timeline-row" [class.has-events]="getTimelineEventsForSurveyor(s.id).length > 0">
            <div class="timeline-surveyor">
              <div class="avatar small" [style.background-color]="getSurveyorColor(s.id)">
                <img *ngIf="!hasAvatarError(s.id)"
                     [src]="getAvatarUrl(s.display_name, 32)"
                     [alt]="s.display_name"
                     (error)="onAvatarError(s.id)"
                     class="avatar-img">
                <span *ngIf="hasAvatarError(s.id)" class="avatar-initials">{{getInitials(s.display_name)}}</span>
              </div>
              <div class="surveyor-info">
                <span class="surveyor-name">{{s.display_name}}</span>
                <span class="surveyor-event-count">{{getTimelineEventsForSurveyor(s.id).length}} events</span>
              </div>
            </div>
            <div class="timeline-events">
              <!-- Events -->
              <div *ngFor="let event of getTimelineEventsForSurveyor(s.id)"
                   class="timeline-event"
                   [style.left.%]="getTimelinePosition(event.start)"
                   [style.width.%]="getTimelineWidth(event.start, event.end)"
                   [style.background-color]="event.backgroundColor"
                   [class.event-busy]="event.extendedProps?.state === 'BUSY'"
                   [class.event-offline]="event.extendedProps?.state === 'OFFLINE'"
                   (click)="openEditModal(event)"
                   [title]="event.title + ' (' + formatTimelineEventTime(event.start, event.end) + ')'">
                <span class="event-label" *ngIf="getTimelineWidth(event.start, event.end) > 8">{{event.title}}</span>
              </div>
            </div>
          </div>
          <!-- Empty state -->
          <div *ngIf="allSurveyors.length === 0" class="timeline-empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <p>No surveyors available</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Heatmap View -->
    <div *ngIf="currentView === 'heatmap'" class="heatmap-container">
      <div class="heatmap-header">
        <button class="nav-btn" (click)="prevHeatmapWeek()">&#9664;</button>
        <h3>{{getHeatmapWeekLabel()}}</h3>
        <button class="nav-btn" (click)="nextHeatmapWeek()">&#9654;</button>
      </div>
      <div class="heatmap-legend">
        <span>Less</span>
        <div class="legend-scale">
          <div class="legend-cell" style="background: #e8f5e9"></div>
          <div class="legend-cell" style="background: #c8e6c9"></div>
          <div class="legend-cell" style="background: #a5d6a7"></div>
          <div class="legend-cell" style="background: #81c784"></div>
          <div class="legend-cell" style="background: #66bb6a"></div>
        </div>
        <span>More</span>
      </div>
      <div class="heatmap-grid">
        <div class="heatmap-row header">
          <div class="heatmap-cell name-cell">Surveyor</div>
          <div class="heatmap-cell day-cell">Sun</div>
          <div class="heatmap-cell day-cell">Mon</div>
          <div class="heatmap-cell day-cell">Tue</div>
          <div class="heatmap-cell day-cell">Wed</div>
          <div class="heatmap-cell day-cell">Thu</div>
          <div class="heatmap-cell day-cell">Fri</div>
          <div class="heatmap-cell day-cell">Sat</div>
        </div>
        <div *ngFor="let s of allSurveyors" class="heatmap-row">
          <div class="heatmap-cell name-cell">
            <div class="avatar small" [style.background-color]="getSurveyorColor(s.id)">
              <img *ngIf="!hasAvatarError(s.id)"
                   [src]="getAvatarUrl(s.display_name, 32)"
                   [alt]="s.display_name"
                   (error)="onAvatarError(s.id)"
                   class="avatar-img">
              <span *ngIf="hasAvatarError(s.id)" class="avatar-initials">{{getInitials(s.display_name)}}</span>
            </div>
            <span>{{s.display_name}}</span>
          </div>
          <div *ngFor="let day of workloadData.get(s.id) || []"
               class="heatmap-cell day-cell"
               [style.background-color]="getHeatmapColor(day.count)"
               [title]="day.count + ' appointments'">
            {{day.count || ''}}
          </div>
        </div>
      </div>
    </div>

    <!-- Map View - Surveyor Locations (controlled by real-time-tracking and google-maps-integration flags) -->
    <div *ngIf="currentView === 'map' && isFeatureEnabled('google-maps-integration')" class="map-view-container">
      <div class="map-header">
        <h3>Surveyor Locations</h3>
        <div class="map-controls">
          <!-- Live Stream Status Indicator -->
          <div class="stream-status" [class.connected]="locationStreamConnected" [class.error]="locationStreamError">
            <span class="status-dot"></span>
            <span class="status-text">{{locationStreamConnected ? 'Live' : (locationStreamError ? 'Reconnecting...' : 'Connecting...')}}</span>
          </div>
          <!-- Trail Toggle -->
          <button class="btn-trail" [class.active]="showTrails" (click)="toggleTrails()" title="Toggle movement trails">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L2 22"></path>
              <circle cx="19" cy="5" r="3"></circle>
              <circle cx="5" cy="19" r="3"></circle>
            </svg>
            Trails
          </button>
          <button class="btn-refresh" (click)="refreshSurveyorLocations()" [disabled]="loadingLocations">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" [class.spinning]="loadingLocations">
              <path d="M23 4v6h-6"></path>
              <path d="M1 20v-6h6"></path>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            {{loadingLocations ? 'Refreshing...' : 'Refresh'}}
          </button>
          <span class="last-update" *ngIf="lastLocationRefresh">
            Last updated: {{formatLocationTime(lastLocationRefresh)}}
          </span>
        </div>
      </div>
      <div class="map-legend">
        <div class="legend-item">
          <span class="legend-marker available"></span>
          <span>Available</span>
        </div>
        <div class="legend-item">
          <span class="legend-marker busy"></span>
          <span>Busy</span>
        </div>
        <div class="legend-item">
          <span class="legend-marker offline"></span>
          <span>Offline</span>
        </div>
        <div class="legend-item">
          <span class="legend-marker no-location"></span>
          <span>No Location</span>
        </div>
      </div>
      <div class="map-content">
        <div id="surveyor-map" class="surveyor-map"></div>
        <div class="surveyor-list-panel">
          <h4>Surveyors ({{getSurveyorsWithLocation().length}}/{{allSurveyors.length}} with location)</h4>
          <div class="surveyor-location-list">
            <div *ngFor="let s of allSurveyors"
                 class="surveyor-location-card"
                 [class.has-location]="s.current_lat && s.current_lng"
                 [class.selected]="selectedMapSurveyorId === s.id"
                 (click)="selectSurveyorOnMap(s)">
              <div class="surveyor-info">
                <div class="avatar small" [style.background-color]="getSurveyorColor(s.id)">
                  <img *ngIf="!hasAvatarError(s.id)"
                       [src]="getAvatarUrl(s.display_name, 32)"
                       [alt]="s.display_name"
                       (error)="onAvatarError(s.id)"
                       class="avatar-img">
                  <span *ngIf="hasAvatarError(s.id)" class="avatar-initials">{{getInitials(s.display_name)}}</span>
                </div>
                <div class="surveyor-details">
                  <span class="surveyor-name">{{s.display_name}}</span>
                  <span class="surveyor-status" [class]="s.current_status?.toLowerCase()">{{s.current_status || 'UNKNOWN'}}</span>
                </div>
              </div>
              <div class="location-info" *ngIf="s.current_lat && s.current_lng">
                <span class="coordinates">{{s.current_lat?.toFixed(4)}}, {{s.current_lng?.toFixed(4)}}</span>
                <span class="last-update" *ngIf="s.last_location_update">{{formatLocationTime(s.last_location_update)}}</span>
              </div>
              <div class="no-location-info" *ngIf="!s.current_lat || !s.current_lng">
                <span>No location data</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


  </div>
</div>

<!-- Create Appointment Modal -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h3>Create Appointment</h3>
    <div class="modal-body">
      <p><strong>Surveyor:</strong> {{modalSurveyorName}}</p>
      <p><strong>Date:</strong> {{modalDate}}</p>
      <p><strong>Time:</strong> {{modalStartTime}} - {{modalEndTime}} ({{modalDuration}})</p>

      <label>
        <strong>📝 Title <span class="required">*</span></strong>
        <div class="field-with-counter">
          <input type="text" [(ngModel)]="modalTitle" placeholder="e.g., Client Meeting, Survey Task..." maxlength="100" required [class.invalid]="modalTitle.trim().length === 0">
          <span class="char-counter" [class]="getTitleCharClass()">{{getTitleCharCount()}}</span>
        </div>
        <span class="validation-error" *ngIf="modalTitle.trim().length === 0">Title is required</span>
      </label>

      <label>
        <strong>💬 Description <span class="required">*</span></strong>
        <div class="field-with-counter">
          <textarea [(ngModel)]="modalDescription" placeholder="Add any additional notes or details..." maxlength="255" rows="3" required [class.invalid]="modalDescription.trim().length === 0"></textarea>
          <span class="char-counter" [class]="getDescriptionCharClass()">{{getDescriptionCharCount()}}</span>
        </div>
        <span class="validation-error" *ngIf="modalDescription.trim().length === 0">Description is required</span>
      </label>

      <label>
        <strong>📊 Status</strong>
        <select [(ngModel)]="modalState">
          <option value="BUSY">🔴 Busy</option>
          <option value="OFFLINE">⚫ Offline</option>
        </select>
      </label>

      <!-- Recurring Options (controlled by recurring-appointments flag) -->
      <div class="recurring-section" *ngIf="isFeatureEnabled('recurring-appointments')">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="modalRecurring">
          <span>Repeat this appointment</span>
        </label>
        <div class="recurring-options" *ngIf="modalRecurring">
          <label>
            Repeat:
            <select [(ngModel)]="modalRecurringType">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </label>
          <label>
            For:
            <select [(ngModel)]="modalRecurringCount">
              <option [value]="2">2 times</option>
              <option [value]="3">3 times</option>
              <option [value]="4">4 times</option>
              <option [value]="5">5 times</option>
              <option [value]="6">6 times</option>
              <option [value]="8">8 times</option>
              <option [value]="12">12 times</option>
            </select>
          </label>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeCreateModal()">Cancel</button>
      <button class="btn-create" (click)="confirmCreate()" [disabled]="!isCreateFormValid()">
        {{modalRecurring ? 'Create ' + modalRecurringCount + ' Appointments' : 'Create'}}
      </button>
    </div>
  </div>
</div>

<!-- Edit Appointment Modal -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h3>{{editIsPast ? 'View Appointment (Past)' : 'Edit Appointment'}}</h3>
    <div class="modal-body">
      <p *ngIf="editIsPast" class="past-warning">This appointment is in the past and cannot be modified.</p>
      <p><strong>Surveyor:</strong> {{editSurveyorName}}</p>
      <p><strong>Date:</strong> {{editDate}}</p>
      <p><strong>Time:</strong> {{editStartTime}} - {{editEndTime}} ({{editDuration}})</p>

      <label>
        <strong>📝 Title <span class="required">*</span></strong>
        <div class="field-with-counter">
          <input type="text" [(ngModel)]="editTitle" placeholder="e.g., Client Meeting, Survey Task..." maxlength="100" [disabled]="editIsPast" required [class.invalid]="editTitle.trim().length === 0 && !editIsPast">
          <span class="char-counter" [class]="getEditTitleCharClass()">{{getEditTitleCharCount()}}</span>
        </div>
        <span class="validation-error" *ngIf="editTitle.trim().length === 0 && !editIsPast">Title is required</span>
      </label>

      <label>
        <strong>💬 Description <span class="required">*</span></strong>
        <div class="field-with-counter">
          <textarea [(ngModel)]="editDescription" placeholder="Add any additional notes or details..." maxlength="255" rows="3" [disabled]="editIsPast" required [class.invalid]="editDescription.trim().length === 0 && !editIsPast"></textarea>
          <span class="char-counter" [class]="getEditDescriptionCharClass()">{{getEditDescriptionCharCount()}}</span>
        </div>
        <span class="validation-error" *ngIf="editDescription.trim().length === 0 && !editIsPast">Description is required</span>
      </label>

      <label>
        <strong>📊 Status</strong>
        <select [(ngModel)]="editState" [disabled]="editIsPast">
          <option value="BUSY">🔴 Busy</option>
          <option value="OFFLINE">⚫ Offline</option>
        </select>
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn-delete" (click)="confirmDelete()" [disabled]="editIsPast" [class.btn-disabled]="editIsPast">Delete</button>
      <button class="btn-reassign" (click)="openReassignFromEdit()" *ngIf="!editIsPast" title="Reassign to another surveyor">Reassign</button>
      <div class="spacer"></div>
      <button class="btn-cancel" (click)="closeEditModal()">{{editIsPast ? 'Close' : 'Cancel'}}</button>
      <button class="btn-create" (click)="confirmUpdate()" *ngIf="!editIsPast" [disabled]="!isEditFormValid()">Save</button>
    </div>
  </div>
</div>

<!-- Reassign Surveyor Picker Modal -->
<div class="modal-overlay" *ngIf="showReassignPicker" (click)="closeReassignPicker()">
  <div class="modal reassign-picker-modal" (click)="$event.stopPropagation()">
    <h3>Reassign To</h3>
    <div class="modal-body">
      <p>Select a surveyor to reassign this appointment to:</p>
      <div class="reassign-surveyor-list">
        <div *ngFor="let s of getReassignableSurveyors()"
             class="reassign-surveyor-option"
             [class.selected]="reassignToSurveyorId === s.id"
             (click)="selectReassignSurveyor(s.id)">
          <div class="avatar small" [style.background-color]="getAvatarColor(s.display_name)">
            {{getInitials(s.display_name)}}
          </div>
          <div class="surveyor-option-info">
            <span class="option-name">{{s.display_name}}</span>
            <span class="option-status" [style.color]="getCurrentStatusColor(s.current_status)">{{s.current_status}}</span>
          </div>
          <span class="option-check" *ngIf="reassignToSurveyorId === s.id">&#10003;</span>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeReassignPicker()">Cancel</button>
      <button class="btn-create" (click)="confirmReassignFromPicker()" [disabled]="reassignToSurveyorId === 0">Reassign</button>
    </div>
  </div>
</div>

<!-- Reschedule Confirmation Modal -->
<div class="modal-overlay" *ngIf="showRescheduleModal" (click)="closeRescheduleModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h3>Confirm Reschedule</h3>
    <div class="modal-body">
      <p><strong>Surveyor:</strong> {{rescheduleSurveyorName}}</p>

      <div class="reschedule-change">
        <div class="change-from">
          <span class="change-label">From:</span>
          <p>{{rescheduleOldDate}}</p>
          <p>{{rescheduleOldTime}}</p>
        </div>
        <div class="change-arrow">&#8594;</div>
        <div class="change-to">
          <span class="change-label">To:</span>
          <p>{{rescheduleNewDate}}</p>
          <p>{{rescheduleNewTime}}</p>
          <p class="duration">({{rescheduleNewDuration}})</p>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeRescheduleModal()">Cancel</button>
      <button class="btn-create" (click)="confirmReschedule()">Confirm Reschedule</button>
    </div>
  </div>
</div>

<!-- Success Confirmation Modal -->
<div class="modal-overlay" *ngIf="showSuccessModal" (click)="closeSuccessModal()">
  <div class="modal success-modal" (click)="$event.stopPropagation()">
    <div class="success-header">
      <div class="success-icon">&#10003;</div>
      <h3>{{successTitle}}</h3>
    </div>
    <div class="modal-body">
      <p class="success-message">{{successMessage}}</p>
      <div class="success-details">
        <div class="detail-row">
          <span class="detail-label">Surveyor</span>
          <span class="detail-value">{{successSurveyorName}}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date</span>
          <span class="detail-value">{{successDate}}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Time</span>
          <span class="detail-value">{{successTime}}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value status-badge" [class.busy]="successState === 'BUSY'" [class.offline]="successState === 'OFFLINE'">
            {{successState}}
          </span>
        </div>
      </div>
    </div>
    <div class="modal-actions centered">
      <button class="btn-success" (click)="closeSuccessModal()">Done</button>
    </div>
  </div>
</div>

<!-- Template Modal -->
<div class="modal-overlay" *ngIf="showTemplateModal" (click)="closeTemplateModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h3>Choose Template</h3>
    <div class="modal-body">
      <div class="template-grid">
        <div *ngFor="let template of templates"
             class="template-card"
             [class.selected]="selectedTemplate?.id === template.id"
             (click)="selectTemplate(template)">
          <div class="template-icon" [style.background-color]="template.color">{{template.duration}}h</div>
          <div class="template-name">{{template.name}}</div>
          <div class="template-state">{{template.state}}</div>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeTemplateModal()">Cancel</button>
      <button class="btn-create" (click)="applyTemplate()" [disabled]="!selectedTemplate">Apply</button>
    </div>
  </div>
</div>

<!-- Export Modal (controlled by pdf-export and excel-export flags) -->
<div class="modal-overlay" *ngIf="showExportModal" (click)="closeExportModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h3>Export Schedule</h3>
    <div class="modal-body">
      <label>
        <strong>Format:</strong>
        <select [(ngModel)]="exportFormat">
          <option *ngIf="isFeatureEnabled('pdf-export')" value="pdf">PDF (Print)</option>
          <option *ngIf="isFeatureEnabled('excel-export')" value="excel">Excel</option>
          <option value="csv">CSV</option>
        </select>
      </label>
      <label>
        <strong>Range:</strong>
        <select [(ngModel)]="exportRange">
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeExportModal()">Cancel</button>
      <button class="btn-create" (click)="exportSchedule()">Export</button>
    </div>
  </div>
</div>

<!-- Color Picker Modal -->
<div class="modal-overlay" *ngIf="showColorPicker" (click)="closeColorPicker()">
  <div class="modal color-picker-modal" (click)="$event.stopPropagation()">
    <h3>Choose Color</h3>
    <div class="modal-body">
      <div class="color-grid">
        <div *ngFor="let color of customColors"
             class="color-swatch"
             [style.background-color]="color"
             (click)="selectColor(color)">
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeColorPicker()">Cancel</button>
    </div>
  </div>
</div>

<!-- Notes Modal -->
<div class="modal-overlay" *ngIf="showNotesModal" (click)="closeNotesModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h3>Notes for {{notesModalSurveyorName}}</h3>
    <div class="modal-body">
      <textarea class="notes-textarea" [(ngModel)]="notesModalContent" placeholder="Add notes about this surveyor..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeNotesModal()">Cancel</button>
      <button class="btn-create" (click)="saveNote()">Save Note</button>
    </div>
  </div>
</div>

<!-- Bulk Assign Modal (controlled by bulk-create-appointments flag) -->
<div class="modal-overlay" *ngIf="showBulkAssignModal && isFeatureEnabled('bulk-create-appointments')" (click)="closeBulkAssignModal()">
  <div class="modal bulk-assign-modal" (click)="$event.stopPropagation()">
    <h3>Bulk Assign Appointments</h3>
    <div class="modal-body">
      <div class="bulk-info">
        <span class="bulk-count">{{bulkAssignSurveyorIds.length}}</span> surveyors selected
      </div>

      <div class="bulk-surveyors-list">
        <div *ngFor="let s of filteredSurveyors"
             class="bulk-surveyor-chip"
             [class.selected]="isBulkSurveyorSelected(s.id)"
             (click)="toggleBulkSurveyorSelection(s.id)">
          <span class="chip-check" *ngIf="isBulkSurveyorSelected(s.id)">&#10003;</span>
          {{s.display_name}}
        </div>
      </div>

      <div class="bulk-form">
        <label>
          <strong>Date</strong>
          <input type="date" [(ngModel)]="bulkAssignDate">
        </label>

        <div class="time-row">
          <label>
            <strong>Start Time</strong>
            <input type="time" [(ngModel)]="bulkAssignStartTime">
          </label>
          <label>
            <strong>End Time</strong>
            <input type="time" [(ngModel)]="bulkAssignEndTime">
          </label>
        </div>

        <label>
          <strong>Status</strong>
          <select [(ngModel)]="bulkAssignState">
            <option value="BUSY">Busy</option>
            <option value="OFFLINE">Offline</option>
          </select>
        </label>

        <label>
          <strong>Title <span class="required">*</span></strong>
          <input type="text" [(ngModel)]="bulkAssignTitle" placeholder="e.g., Team Meeting, Training..." maxlength="100" [class.invalid]="bulkAssignTitle.trim().length === 0">
        </label>

        <label>
          <strong>Description <span class="required">*</span></strong>
          <textarea [(ngModel)]="bulkAssignDescription" placeholder="Appointment details..." maxlength="255" rows="2" [class.invalid]="bulkAssignDescription.trim().length === 0"></textarea>
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeBulkAssignModal()">Cancel</button>
      <button class="btn-create" (click)="confirmBulkAssign()" [disabled]="!isBulkAssignFormValid()">
        Create {{bulkAssignSurveyorIds.length}} Appointments
      </button>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Help Modal -->
<div class="modal-overlay" *ngIf="showKeyboardHelp" (click)="toggleKeyboardHelp()">
  <div class="modal keyboard-help-modal" (click)="$event.stopPropagation()">
    <div class="keyboard-header">
      <h3>Keyboard Shortcuts</h3>
      <button class="close-btn" (click)="toggleKeyboardHelp()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="shortcut-section">
        <h4>Navigation</h4>
        <div class="shortcut-row">
          <kbd>T</kbd>
          <span>Go to Today</span>
        </div>
        <div class="shortcut-row">
          <kbd>S</kbd>
          <span>Toggle Sidebar</span>
        </div>
        <div class="shortcut-row">
          <kbd>D</kbd>
          <span>Toggle Dashboard</span>
        </div>
        <div class="shortcut-row">
          <kbd>O</kbd>
          <span>Resource Timeline</span>
        </div>
      </div>

      <div class="shortcut-section">
        <h4>Selection</h4>
        <div class="shortcut-row">
          <kbd>A</kbd>
          <span>Select All Surveyors</span>
        </div>
        <div class="shortcut-row">
          <kbd>C</kbd>
          <span>Clear Selection</span>
        </div>
      </div>

      <div class="shortcut-section">
        <h4>Actions</h4>
        <div class="shortcut-row">
          <kbd>B</kbd>
          <span>Bulk Assign (with selection)</span>
        </div>
        <div class="shortcut-row">
          <kbd>R</kbd>
          <span>Refresh Events</span>
        </div>
        <div class="shortcut-row">
          <kbd>E</kbd>
          <span>Export Schedule</span>
        </div>
        <div class="shortcut-row">
          <kbd>Esc</kbd>
          <span>Close Modal</span>
        </div>
        <div class="shortcut-row">
          <kbd>?</kbd>
          <span>Show This Help</span>
        </div>
      </div>

      <div class="shortcut-section">
        <h4>Calendar Actions</h4>
        <div class="shortcut-row">
          <kbd>Option/Alt</kbd> + <span class="drag-text">Drag</span>
          <span>Copy Appointment</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Copy Appointment Modal (Alt+Drag to Copy) -->
<div class="modal-overlay" *ngIf="showCopyModal" (click)="closeCopyModal()">
  <div class="modal copy-modal" (click)="$event.stopPropagation()">
    <h3>Copy Appointment</h3>
    <div class="modal-body">
      <p><strong>Surveyor:</strong> {{copySurveyorName}}</p>

      <div class="copy-change">
        <div class="change-from">
          <span class="change-label">Original:</span>
          <p>{{copyOriginalDate}}</p>
          <p>{{copyOriginalTime}}</p>
        </div>
        <div class="change-arrow copy-arrow">&#10145;</div>
        <div class="change-to">
          <span class="change-label">Copy To:</span>
          <p>{{copyNewDate}}</p>
          <p>{{copyNewTime}}</p>
          <p class="duration">({{copyNewDuration}})</p>
        </div>
      </div>

      <div class="copy-details">
        <label>
          <strong>Status</strong>
          <select [(ngModel)]="copyState">
            <option value="BUSY">Busy</option>
            <option value="OFFLINE">Offline</option>
          </select>
        </label>

        <label>
          <strong>Title</strong>
          <input type="text" [(ngModel)]="copyTitle" placeholder="Appointment title..." maxlength="100">
        </label>

        <label>
          <strong>Description</strong>
          <textarea [(ngModel)]="copyDescription" placeholder="Appointment details..." maxlength="255" rows="2"></textarea>
        </label>
      </div>

      <p class="copy-hint">The original appointment will be kept. A new copy will be created at the new time.</p>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeCopyModal()">Cancel</button>
      <button class="btn-create" (click)="confirmCopy()">Create Copy</button>
    </div>
  </div>
</div>

<!-- Reassign Modal (Drag to different surveyor) -->
<div class="modal-overlay" *ngIf="showReassignModal" (click)="closeReassignModal()">
  <div class="modal reassign-modal" (click)="$event.stopPropagation()">
    <h3>Reassign Appointment</h3>
    <div class="modal-body">
      <div class="reassign-change">
        <div class="change-from reassign-from">
          <span class="change-label">From:</span>
          <div class="surveyor-chip">
            <div class="avatar small" [style.background-color]="getAvatarColor(reassignFromSurveyorName)">
              {{getInitials(reassignFromSurveyorName)}}
            </div>
            <span>{{reassignFromSurveyorName}}</span>
          </div>
        </div>
        <div class="change-arrow reassign-arrow">&#10145;</div>
        <div class="change-to reassign-to">
          <span class="change-label">To:</span>
          <div class="surveyor-chip">
            <div class="avatar small" [style.background-color]="getAvatarColor(reassignToSurveyorName)">
              {{getInitials(reassignToSurveyorName)}}
            </div>
            <span>{{reassignToSurveyorName}}</span>
          </div>
        </div>
      </div>

      <div class="reassign-details">
        <p><strong>Date:</strong> {{reassignDate}}</p>
        <p><strong>Time:</strong> {{reassignTime}} ({{reassignDuration}})</p>
        <p><strong>Status:</strong> {{reassignState}}</p>
        <p *ngIf="reassignTitle"><strong>Title:</strong> {{reassignTitle}}</p>
      </div>

      <p class="reassign-hint">This will move the appointment from {{reassignFromSurveyorName}} to {{reassignToSurveyorName}}.</p>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeReassignModal()">Cancel</button>
      <button class="btn-create" (click)="confirmReassign()">Confirm Reassign</button>
    </div>
  </div>
</div>

<!-- Conflict Panel (controlled by conflict-detection flag) -->
<div class="side-panel conflict-panel" *ngIf="showConflictPanel && isFeatureEnabled('conflict-detection')">
  <div class="panel-header">
    <h3>Scheduling Conflicts</h3>
    <button class="close-btn" (click)="toggleConflictPanel()">&#10005;</button>
  </div>
  <div class="panel-content">
    <div *ngIf="conflictWarnings.length === 0" class="no-conflicts">
      <span class="success-icon">&#10003;</span>
      <p>No scheduling conflicts detected</p>
    </div>
    <div *ngFor="let warning of conflictWarnings" class="conflict-group">
      <div class="conflict-surveyor">
        <div class="avatar small" [style.background-color]="getAvatarColor(warning.surveyorName)">
          {{getInitials(warning.surveyorName)}}
        </div>
        <span>{{warning.surveyorName}}</span>
        <span class="conflict-badge">{{warning.conflictCount}}</span>
      </div>
      <div class="conflict-list">
        <div *ngFor="let conflict of warning.conflicts" class="conflict-item" [style.border-left-color]="getConflictColor(conflict.overlapMinutes)">
          <div class="conflict-time">{{conflict.overlapMinutes}} min overlap</div>
          <div class="conflict-events">
            <span>{{conflict.event1.title.split(' - ')[1] || 'Event 1'}}</span>
            <span class="conflict-vs">vs</span>
            <span>{{conflict.event2.title.split(' - ')[1] || 'Event 2'}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Travel Time Panel (controlled by eta-tracking flag) -->
<div class="side-panel travel-time-panel" *ngIf="showTravelTimePanel && isFeatureEnabled('eta-tracking')">
  <div class="panel-header">
    <h3>Travel Time Analysis</h3>
    <button class="close-btn" (click)="toggleTravelTimes()">&#10005;</button>
  </div>
  <div class="panel-summary">
    <div class="summary-stat">
      <span class="summary-value">{{getTravelTimeSummary().length}}</span>
      <span class="summary-label">Surveyors</span>
    </div>
    <div class="summary-stat">
      <span class="summary-value warning" *ngIf="hasTightSchedules()">
        {{getTightScheduleCount()}}
      </span>
      <span class="summary-value" *ngIf="!hasTightSchedules()">0</span>
      <span class="summary-label">Tight Schedules</span>
    </div>
  </div>
  <div class="panel-content">
    <div *ngIf="getTravelTimeSummary().length === 0" class="empty-state">
      <p>No travel time data for today's appointments.</p>
      <p class="hint">Travel times are calculated based on surveyor schedules.</p>
    </div>
    <div *ngFor="let s of getTravelTimeSummary()" class="travel-surveyor-section">
      <div class="travel-surveyor-header">
        <div class="avatar small" [style.background-color]="getAvatarColor(s.surveyorName)">
          {{getInitials(s.surveyorName)}}
        </div>
        <span class="surveyor-name">{{s.surveyorName}}</span>
        <span class="travel-warning-count" *ngIf="hasTightEstimates(s.estimates)">
          {{getTightEstimateCount(s.estimates)}} warning{{getTightEstimateCount(s.estimates) > 1 ? 's' : ''}}
        </span>
      </div>
      <div class="travel-routes">
        <div *ngFor="let est of s.estimates" class="travel-route" [class.tight]="est.isTight" [class.ok]="!est.isTight && est.gapMinutes > 0">
          <div class="route-info">
            <div class="route-from">
              <span class="route-icon">📍</span>
              <span class="route-label">{{getEventTitle(est.fromEvent)}}</span>
              <span class="route-time" *ngIf="est.fromEvent">ends {{formatEventTime(est.fromEvent)}}</span>
            </div>
            <div class="route-arrow">→</div>
            <div class="route-to">
              <span class="route-icon">🎯</span>
              <span class="route-label">{{getEventTitle(est.toEvent)}}</span>
              <span class="route-time">starts {{formatEventTime(est.toEvent)}}</span>
            </div>
          </div>
          <div class="route-timing">
            <span class="travel-time">~{{est.travelMinutes}} min travel</span>
            <span class="gap-time" *ngIf="est.gapMinutes > 0" [class.tight]="est.isTight">
              {{est.gapMinutes}} min gap
              <span class="status-icon" *ngIf="est.isTight">⚠️</span>
              <span class="status-icon" *ngIf="!est.isTight">✓</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Workload Balance Panel (controlled by workload-balancing flag) -->
<div class="side-panel workload-panel" *ngIf="showWorkloadPanel && isFeatureEnabled('workload-balancing')">
  <div class="panel-header">
    <h3>Workload Balance</h3>
    <button class="close-btn" (click)="toggleWorkloadPanel()">&#10005;</button>
  </div>
  <div class="panel-summary">
    <div class="summary-stat">
      <span class="summary-value">{{getAverageWorkload()}}h</span>
      <span class="summary-label">Avg Weekly</span>
    </div>
    <div class="summary-stat">
      <span class="summary-value" [class]="getWorkloadVariance().toLowerCase()">{{getWorkloadVariance()}}</span>
      <span class="summary-label">Distribution</span>
    </div>
  </div>
  <div class="panel-content">
    <div *ngFor="let w of workloadBalance" class="workload-row">
      <div class="workload-surveyor">
        <div class="avatar small" [style.background-color]="getAvatarColor(w.surveyorName)">
          {{getInitials(w.surveyorName)}}
        </div>
        <div class="workload-info">
          <span class="workload-name">{{w.surveyorName}}</span>
          <span class="workload-stats">{{w.appointmentsToday}} today | {{w.appointmentsWeek}} this week</span>
        </div>
      </div>
      <div class="workload-bar-container">
        <div class="workload-bar" [style.width.%]="getWorkloadBarWidth(w.hoursWeek)" [style.background-color]="getWorkloadColor(w.hoursWeek)"></div>
        <span class="workload-hours">{{w.hoursWeek}}h</span>
      </div>
      <span class="workload-status" [style.color]="getWorkloadColor(w.hoursWeek)">{{getWorkloadStatus(w.hoursWeek)}}</span>
    </div>
  </div>
</div>

<!-- Keyboard Help Hint -->
<div class="keyboard-hint" (click)="toggleKeyboardHelp()">
  Press <kbd>?</kbd> for shortcuts
</div>

<!-- Push Notification Registration Modal (controlled by push-notifications flag) -->
<div class="modal-overlay" *ngIf="showPushRegistrationModal && isFeatureEnabled('push-notifications')" (click)="closePushRegistrationModal()">
  <div class="modal push-registration-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Enable Push Notifications</h3>
      <button class="close-btn" (click)="closePushRegistrationModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <p class="push-info">Select the surveyor you want to receive notifications for. You'll get alerts when appointments are created, updated, or deleted for this surveyor.</p>

      <label>
        <strong>Search Surveyor</strong>
        <input type="text" [(ngModel)]="pushRegistrationSurveyorSearch"
               placeholder="Type to search by name or code..."
               class="surveyor-search-input">
      </label>

      <div class="surveyor-list">
        <div *ngFor="let surveyor of getFilteredPushSurveyors()"
             class="surveyor-option"
             [class.selected]="pushRegistrationSurveyorId === surveyor.id"
             (click)="selectPushSurveyor(surveyor.id)">
          <div class="surveyor-option-info">
            <span class="surveyor-name">{{surveyor.display_name}}</span>
            <span class="surveyor-code">{{surveyor.code}}</span>
          </div>
          <span class="surveyor-type-badge" [class.internal]="surveyor.surveyor_type === 'INTERNAL'">
            {{surveyor.surveyor_type}}
          </span>
        </div>
        <div *ngIf="getFilteredPushSurveyors().length === 0" class="no-surveyors">
          No surveyors found matching "{{pushRegistrationSurveyorSearch}}"
        </div>
      </div>

      <div *ngIf="pushRegistrationSurveyorId" class="selected-surveyor">
        <strong>Selected:</strong> {{getRegisteredSurveyorName()}}
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closePushRegistrationModal()">Cancel</button>
      <button class="btn btn-primary" (click)="confirmPushRegistration()" [disabled]="!pushRegistrationSurveyorId">
        Enable Notifications
      </button>
    </div>
  </div>
</div>

<!-- Chat Panel (controlled by feature flag) -->
<div class="chat-panel" *ngIf="showChatPanel && isFeatureEnabled('chat-v2')">
  <div class="chat-header">
    <h3>
      <span class="connection-status" [class.disconnected]="!chatConnected" [class.connecting]="!chatConnected"></span>
      Chat
    </h3>
    <button class="close-btn" (click)="closeChatPanel()">&#10005;</button>
  </div>

  <div class="chat-content">
    <!-- New Conversation Picker -->
    <div *ngIf="showNewConversationPicker" class="surveyor-picker">
      <h4>Start New Conversation</h4>
      <input type="text"
             class="surveyor-picker-search"
             [(ngModel)]="chatSurveyorSearch"
             placeholder="Search surveyors...">
      <div class="surveyor-picker-list">
        <div *ngFor="let s of getFilteredChatSurveyors()"
             class="surveyor-picker-item"
             (click)="startConversationWith(s)">
          <div class="avatar" [style.background-color]="getChatAvatarColor(s.display_name)">
            {{getChatInitials(s.display_name)}}
          </div>
          <div class="info">
            <div class="name">{{s.display_name}}</div>
            <div class="status">{{s.current_status}}</div>
          </div>
        </div>
      </div>
      <button class="new-conversation-btn" style="margin-top: 12px; color: #666;" (click)="cancelNewConversation()">
        Cancel
      </button>
    </div>

    <!-- Conversation List (when no active conversation) -->
    <ng-container *ngIf="!activeConversationId && !showNewConversationPicker">
      <button class="new-conversation-btn" (click)="showNewConversation()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        New Conversation
      </button>

      <div class="conversations-list" *ngIf="chatConversations.length > 0">
        <div *ngFor="let conv of chatConversations"
             class="conversation-item"
             [class.active]="activeConversationId === conv.conversationId"
             (click)="openConversation(conv)">
          <div class="conversation-avatar" [style.background-color]="getChatAvatarColor(conv.otherPartyName)">
            {{getChatInitials(conv.otherPartyName)}}
          </div>
          <div class="conversation-info">
            <div class="conversation-name">{{conv.otherPartyName}}</div>
            <div class="conversation-preview">{{conv.lastMessage}}</div>
          </div>
          <div class="conversation-meta">
            <span class="conversation-time">{{formatChatTime(conv.lastMessageAt)}}</span>
            <span class="conversation-unread" *ngIf="conv.unreadCount > 0">{{conv.unreadCount}}</span>
          </div>
        </div>
      </div>

      <div class="no-conversation" *ngIf="chatConversations.length === 0">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <p>No conversations yet</p>
        <span>Start a new conversation with a surveyor</span>
      </div>
    </ng-container>

    <!-- Active Conversation Messages -->
    <div class="messages-container" *ngIf="activeConversationId && !showNewConversationPicker">
      <div class="messages-header">
        <button class="back-btn" (click)="backToConversations()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <div class="messages-header-info">
          <div class="messages-header-name">{{activeConversationName}}</div>
          <div class="messages-header-status" *ngIf="chatTypingUser && isFeatureEnabled('typing-indicators')">typing...</div>
        </div>
      </div>

      <div class="messages-list">
        <div *ngIf="chatMessages.length === 0" class="no-messages">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <p>No messages yet</p>
          <span>Send a message to start the conversation</span>
        </div>

        <div *ngFor="let msg of chatMessages"
             class="message-bubble"
             [class.sent]="isChatMessageSent(msg)"
             [class.received]="!isChatMessageSent(msg)">
          <div class="message-content">{{msg.content}}</div>
          <div class="message-meta">
            <span>{{formatChatTime(msg.sentAt)}}</span>
            <!-- Read receipts (controlled by read-receipts flag) -->
            <span *ngIf="isChatMessageSent(msg) && isFeatureEnabled('read-receipts')" class="message-status-icon" [class]="msg.status.toLowerCase()">
              <span class="material-icons" style="font-size: 14px;">{{getChatMessageStatusIcon(msg)}}</span>
            </span>
          </div>
        </div>

        <!-- Typing indicator (controlled by typing-indicators flag) -->
        <div class="typing-indicator" *ngIf="chatTypingUser && isFeatureEnabled('typing-indicators')">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span>{{chatTypingUser}} is typing...</span>
        </div>
      </div>

      <div class="message-input-container">
        <textarea class="message-input"
                  [(ngModel)]="chatMessageInput"
                  (keydown)="onChatInputKeydown($event)"
                  placeholder="Type a message..."
                  rows="1"></textarea>
        <button class="send-btn"
                (click)="sendChatMessage()"
                [disabled]="!chatMessageInput.trim()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

